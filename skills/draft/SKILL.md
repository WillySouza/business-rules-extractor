---
name: draft
description: Draft a business rules markdown document from mapped evidence using the base template.
---

# Draft Business Rules Document

## Objective

Convert mapped evidence into a feature-level business rules document without adding unsupported claims.

## Inputs

- Mode (`single_repo` or `multi_repo_compare`)
- Mapped evidence inventory
- Target repository path
- Feature scope (sub-feature name for scoped extractions)
- Output path
- `depth` (default `full`)
- `product_mode` (default `true`)
- `cross_domain_policy` (default `reference_only`)
- `extraction_options` (controls which sections are generated):
  - `business_rules` (default `true`): Rule Details, Assumptions, Open Questions, Decision Log
  - `technical_rules` (default `false`): Technical Trace, Dependencies and Impact
  - `usage_context` (default `false`): Usage Context section
  - `examples` (default `false`): Concrete Examples section

## Required Document Structure

The output document **must** follow this exact structure. Fill in each section from the mapped evidence. Do not reorder, rename, or number the headings.

---BEGIN REQUIRED STRUCTURE---

# Business Rule Document

> Write all section content in English unless explicitly requested otherwise.

## Feature Metadata

- **Feature Name:** `<feature-name>`
- **Sub-feature:** `<sub-feature-name>`
- **Domain:** `<domain-name>`
- **Source Repo:** `<absolute-path-to-target-repo>`
- **Last Updated:** `<YYYY-MM-DD>`

## Business Rule Summary

`<2-6 bullets in business language describing what the feature enforces>`

## Rule Details

### Rule 1 - `<rule-title>`
- **Business Intent:** `<why this rule exists>`
- **Trigger:** `<when this rule starts>`
- **Conditions:** `<main conditions and branches>`
- **Delegation:** `<if this rule's core decision is NOT made here: state what is NOT decided locally, which interface/service/facade receives the decision, and whether behavior is polymorphic across implementations. Omit if logic is local.>`
- **Outcome:** `<state/result generated by this rule>`
- **Exceptions:** `<known edge cases or explicit non-handled flows>`
- **Confidence:** `<high|medium|low>`

## Technical Trace

- **Entrypoints:** `<controller/command/job/webhook>`
- **Application Logic:** `<actions/services used to enforce rule>`
- **Validation Layer:** `<requests/validators/policies>`
- **Persistence Layer:** `<repositories/models touched>`
- **Async Side Effects:** `<jobs/events/queues>`
- **External Integrations:** `<carrier/api/services>`

## Dependencies and Impact

- **Upstream Dependencies:** `<what this feature depends on>`
- **Downstream Dependencies:** `<what can break if this rule changes>`
- **Related Features:** `<cross-feature coupling>`

## Usage Context

- **Trigger:** `<what initiates this feature>`
- **Pre-conditions:** `<required state before execution>`
- **Post-conditions:** `<state after successful execution>`
- **Entry Paths:** `<UI, API, webhook, scheduled task>`

## Concrete Examples

### Example 1 - `<scenario-title>`
- **Input/Payload:** `<request or trigger data>`
- **State Before:** `<relevant state before execution>`
- **State After:** `<resulting state and side effects>`

## Evidence Map

List only references used as evidence for this document.

- `<path>#<symbol-or-context> - <short reason this supports the rule>`

## Assumptions

- `<assumption-1>`

## Open Questions (Human-in-the-loop)

Use the `AskQuestion` tool to collect answers before finalizing.
Keep only unresolved questions in this section.

- `<question-1>`

## Decision Log

- `<YYYY-MM-DD> - <decision made after human clarification (source: AskQuestion)>`

---END REQUIRED STRUCTURE---

## Section Ordering Rules

1. **Feature Metadata** — always first
2. **Business Rule Summary** — always second
3. **Rule Details** — only if `business_rules` is active
4. **Technical Trace** — only if `technical_rules` is active
5. **Dependencies and Impact** — only if `technical_rules` is active
6. **Usage Context** — only if `usage_context` is active
7. **Concrete Examples** — only if `examples` is active
8. **Evidence Map** — always present
9. **Assumptions** — only if `business_rules` is active
10. **Open Questions (Human-in-the-loop)** — only if `business_rules` is active
11. **Decision Log** — only if `business_rules` is active

**Critical: sections for inactive `extraction_options` must be completely ABSENT from the output — not empty, not with placeholders, just omitted entirely.**

## Source Reference Format

All source references in the document must use this format:

`> **Source:** [Filename.ext:N-M](vscode://file//absolute/path/to/file:N)`

Path construction: `vscode://file//` + `target_repo` + `/` + relative path within repo (e.g. `src/Actions/DoThing.php`) + `:` + start line. For ranges, use only the start line in the link; the full range (`N-M`) appears in the display text only.

Place as a blockquote **after** the closing ``` of any code block. For evidence without a code block, use the same format inline.

## Rules

- Use only mapped evidence as factual support.
- If evidence is missing, move text to `Assumptions` or `Open Questions`.
- Keep primary rule text in product language when `product_mode=true`.
- Do not include implementation references in summary/rule text; keep code references in `Evidence Map`.
- Assign confidence per rule:
  - `high`: explicitly proven by code paths
  - `medium`: partial support or indirect evidence
  - `low`: ambiguity or missing coverage

## Open Questions Gate

Before returning the drafted document, review every question you placed in `Open Questions (Human-in-the-loop)`.

- If any question is unresolved and answering it would change a rule claim, use `AskQuestion` to collect the answer before finalizing.
- After receiving answers, promote them to the `Decision Log` and update affected rules.
- Only skip this gate if `Open Questions` is empty.

## Delegation Documentation

When a rule's core decision is NOT executed within the entry-point method itself (delegated to an interface, polymorphic service, or facade):

1. **State the negative explicitly** in the rule text — e.g., *"The `<decision>` is not made in `<method>` — it is fully delegated to `<interface>`."* Do not just describe the delegation call as an action; state that the entry point has no decision authority.

2. **Name the delegation mechanism** — interface method, facade, event, etc.

3. **Document polymorphic implementations** — if the delegate is polymorphic (e.g., a per-corporation service), add a sub-rule or subsection per key implementation with its own conditions and outcome table/bullets. Use the format: `### Rule N.1 - <DelegateClass>: <short description>`.

4. **Populate the `Delegation:` field** in the Rule Details entry.

## Document Requirements

Always include regardless of `extraction_options`:

- Feature Metadata
- Business Rule Summary
- Evidence Map

Include only sections corresponding to active `extraction_options`:

| Option | Sections generated |
|---|---|
| `business_rules` | Rule Details, Assumptions, Open Questions, Decision Log |
| `technical_rules` | Technical Trace, Dependencies and Impact |
| `usage_context` | Usage Context (trigger, pre/post conditions, entry paths) |
| `examples` | Concrete Examples (scenarios with payloads and state transitions) |

Omit sections for inactive options entirely — do not include empty placeholders.

For `depth=full`, add explicit entrypoint-lifecycle coverage:

- include at least one rule or subsection per in-scope entrypoint
- explain what happens after each entrypoint through downstream handlers
- include terminal outcomes and side effects for each entrypoint chain

If callback endpoints are in-scope (for example `webhook`, `outbound-callback`), they must be explicitly documented in primary rule details (not only technical trace).

Cross-domain handling:

- If `cross_domain_policy=reference_only`, do not expand cross-domain rules in `Rule Details`.
- Mention cross-domain links as dependencies in `Dependencies and Impact`.
- Optionally list unresolved adjacent-domain gaps in `Open Questions`.

## Output

Produce a draft markdown ready for quality validation.

If mode is `multi_repo_compare`, output structure must include:

- Shared Rules
- Legacy-only Rules
- New API-only Rules
- Behavior Drift / Gaps
- Migration Risks

## Phase Block

Open your output with:

```
━━━ [DRAFT] ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Sub-feature: <sub-feature scope>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
